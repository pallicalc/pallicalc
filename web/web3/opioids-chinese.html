<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿片类药物和吗啡 | 患者指南</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; 
            max-width: 480px; 
            margin: 0 auto; 
            padding: 0 16px 120px 16px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.6;
            font-size: 16px;
            color: #333;
        }
        .header { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
            padding: 24px 20px; 
            border-radius: 0 0 24px 24px; 
            margin-bottom: 24px; 
            position: relative;
            overflow: hidden;
        }
        .header h1 { font-size: 28px; font-weight: 700; margin: 0 0 12px 0; }
        .header p { font-size: 14px; opacity: 0.95; margin: 0; }
        .nav-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            padding: 14px 20px; border-radius: 20px; margin-bottom: 28px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .nav-link { 
            display: flex; align-items: center; gap: 8px; 
            color: #4facfe; font-weight: 600; font-size: 15px; 
            text-decoration: none; padding: 8px 12px; 
            border-radius: 12px; transition: all 0.3s ease; cursor: pointer;
        }
        .nav-link:active { background: rgba(79, 172, 254, 0.2); }
        .section { 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 28px 24px; margin-bottom: 24px; border-radius: 24px; 
            box-shadow: 0 12px 40px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.2);
        }
        .section h2 { 
            font-size: 22px; font-weight: 700; margin: 0 0 20px 0; 
            display: flex; align-items: center; gap: 12px; color: #2c3e50;
        }
        .fear-grid { display: grid; gap: 20px; margin-top: 20px; }
        .fear-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 16px;
        }
        .fear-card strong { font-size: 18px; display: block; margin-bottom: 8px; }
        .side-effects-grid { display: grid; gap: 16px; margin-top: 20px; }
        .side-effect {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px; border-radius: 16px; border-left: 5px solid #ff8c42;
        }
        .side-effect strong { font-size: 18px; color: #e74c3c; display: block; margin-bottom: 8px; }
        .rules-grid { display: grid; gap: 16px; margin-top: 20px; }
        .rule-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px; border-radius: 16px; border-left: 5px solid #00b894;
            display: flex; align-items: flex-start; gap: 12px;
        }
        .rule-number {
            background: #00b894; color: white; width: 32px; height: 32px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 16px; flex-shrink: 0;
        }
        .action-buttons { 
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 16px; z-index: 100; padding: 12px;
        }
        .btn { 
            padding: 16px 28px !important; border: none !important; border-radius: 50px !important; 
            font-size: 16px !important; font-weight: 600 !important; cursor: pointer !important; 
            display: flex !important; align-items: center !important; gap: 10px !important; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important; text-decoration: none !important;
            backdrop-filter: blur(10px) !important; transition: all 0.3s ease !important;
            min-height: 56px !important;
        }
        .btn-pdf { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important; color: white !important; }
        .btn:active { transform: translateY(-2px) !important; }
        
        .settings-btn { 
            position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; 
            color: white !important; border: none !important; border-radius: 50% !important; 
            font-size: 24px !important; cursor: pointer !important; 
            box-shadow: 0 8px 25px rgba(102,126,234,0.4) !important; z-index: 1000 !important;
            /* Hidden by default, shown only for personal users via JS */
            display: none; 
        }
        .settings-btn:active { transform: scale(0.95) !important; }
        
        /* QR Modal */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); /* Darker backdrop */
            z-index: 2000; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content { 
            background: white; padding: 32px; border-radius: 24px; max-width: 420px; width: 95%; 
            max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }
        .close { 
            float: right; font-size: 32px; cursor: pointer; color: #999; 
            font-weight: 300; margin-top: -8px; line-height: 1;
        }
        .close:active { color: #333; }

        /* --- DARK MODE FIX START --- */
        /* This specific styling prevents browsers from inverting the QR code */
        #qrcode-wrapper-safe {
            background-color: #ffffff !important;
            border-radius: 16px;
            padding: 20px;
            margin: 20px auto;
            text-align: center;
            
            /* Forces the browser to render this element in light mode only */
            color-scheme: light only;
            /* Prevents color blending with dark backgrounds */
            isolation: isolate;
        }

        #qrcode {
            display: inline-block;
            background-color: #ffffff !important;
            padding: 10px;
            border-radius: 8px;
        }

        /* Target the images generated by the library */
        #qrcode img, 
        #qrcode canvas {
            display: block;
            background-color: #ffffff !important;
            /* Adds a white border around the actual code to ensure contrast */
            border: 8px solid #ffffff !important; 
        }
        /* --- DARK MODE FIX END --- */

        @media print { body { display: none; } }
        .no-print { display: block !important; }
        @media (max-width: 480px) {
            body { padding: 0 12px 120px 12px; }
            .action-buttons { gap: 12px; padding: 8px; }
            .btn { padding: 14px 20px !important; font-size: 15px !important; }
        }

        /* Loading Overlay for PDF */
        #pdf-loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 3000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="pdf-loading">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; margin-bottom: 20px; border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite;"></div>
        <div style="font-weight: bold; color: #555;">正在生成 PDF...<br>Generating PDF...</div>
        <style>@keyframes spinner-border { to { transform: rotate(360deg); } }</style>
    </div>

    <div class="header">
        <h1>🩺 阿片类药物和吗啡</h1>
        <p>疼痛缓解和舒适护理指南</p>
    </div>

    <div class="nav-bar">
        <div class="nav-link" onclick="goBack()">
            <i class="bi bi-arrow-left"></i>
            返回手册
        </div>
        <div class="nav-link" onclick="showQR()">
            <i class="bi bi-share-fill"></i>
            分享
        </div>
    </div>

    <div class="section">
        <h2><i class="bi bi-capsule-pill"></i> 什么是阿片类药物？</h2>
        <p>阿片（英语 opioid），又叫鸦片，被开处方用于控制疼痛、呼吸急促和咳嗽.</p>
        <p>它们有不同的剂型，如液体、药片、贴片和注射剂。阿片类药物：可待因 (Codeine)、曲马多 (Tramadol)、吗啡 (Morphine)、芬太尼 (Fentanyl) 和 羟考酮 (Oxycodone)。</p>
        <p><strong>吗啡</strong>是治疗癌症疼痛的金标准。</p>
        <p>吗啡起效迅速，口服后 1 小时达到最大效果，效果大约在 4 小时后减弱。</p>
    </div>

    <div class="section">
        <h2><i class="bi bi-shield-check"></i> 对阿片类药物的常见恐惧</h2>
        <div class="fear-grid">
            <div class="fear-card">
                <strong>阿片类药物会加速死亡吗？</strong>
                <p>如果正确使用，阿片类药物不会缩短您的寿命。研究发现，接受吗啡治疗的缓和疗法患者由于优化了舒适度和提高了生活质量而活得更久。</p>
            </div>
            <div class="fear-card">
                <strong>我服用阿片类药物会导致成瘾吗？</strong>
                <p>如果按照您的医疗团队的指导使用，阿片类药物不会导致成瘾。</p>
            </div>
            <div class="fear-card">
                <strong>阿片类药物会掩盖我的疼痛和病情吗？</strong>
                <p>良好的疼痛控制不会掩盖您的病情。除了疼痛，还有其他症状和检查可以更可靠地评估您的病情。</p>
            </div>
            <div class="fear-card">
                <strong>我应该只在无法忍受疼痛时才服用吗？</strong>
                <p>有些人认为疼痛是疾病不可避免的一部分，会等到疼痛达到不可忍受的程度才采取措施。事实上，疼痛越早管理越有效。</p>
            </div>
            <div class="fear-card">
                <strong>效果会随着时间减弱吗？</strong>
                <p>阿片类药物的止痛效果不会随着时间减弱。如果由于疾病进展而导致您的疼痛加重，您可能需要更高剂量的阿片类药物（没有最大剂量限制）。</p>
            </div>
            <div class="fear-card">
                <strong>服用阿片类药物是否意味着死亡即将来临？</strong>
                <p>不，这种说法是不正确的。阿片类药物广泛用于控制严重疼痛，以使您能够舒适地进行日常活动，享受良好的生活质量。</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2><i class="bi bi-patch-check"></i> 常见副作用</h2>
        <div class="side-effects-grid">
            <div class="side-effect">
                <strong>便秘</strong>
                <p>阿片类药物通常与泻药一起使用，以预防或缓解便秘。</p>
            </div>
            <div class="side-effect">
                <strong>口干</strong>
                <p>全天喝水或含冰块。使用口腔喷雾保持口腔湿润，或含糖果/酸味食物。</p>
            </div>
            <div class="side-effect">
                <strong>恶心和呕吐（暂时）</strong>
                <p>在餐后服用药物。</p>
            </div>
            <div class="side-effect">
                <strong>嗜睡/头晕（暂时）</strong>
                <p>不要驾驶，也不要使用工具或机器。</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2><i class="bi bi-list-check"></i> 如何服用阿片类药物</h2>
        <div class="rules-grid">
            <div class="rule-card">
                <div class="rule-number">1</div>
                <p>请勿超过医生开处方的剂量。</p>
            </div>
            <div class="rule-card">
                <div class="rule-number">2</div>
                <p>请勿为补偿漏服的剂量而服用双倍剂量。</p>
            </div>
            <div class="rule-card">
                <div class="rule-number">3</div>
                <p>突发疼痛：在上一次服用后至少等待 1 小时才能服用额外剂量。</p>
            </div>
            <div class="rule-card">
                <div class="rule-number">4</div>
                <p>记录您当天服用的额外剂量，并在下次就诊时告知医生。</p>
            </div>
        </div>
    </div>

    <div class="action-buttons no-print">
        <button class="btn btn-pdf" onclick="printPDF()" style="min-width: 140px;">
            <i class="bi bi-printer-fill"></i> 打印 PDF
        </button>
    </div>

    <button id="settingsBtn" class="settings-btn no-print" onclick="openSettings()" title="Clinic Settings">
        <i class="bi bi-gear-fill"></i>
    </button>

    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeQR()">&times;</span>
            <h3 style="margin: 0 0 20px 0;">📱 分享手册</h3>
            
            <div id="qrcode-wrapper-safe">
                <div id="qrcode"></div>
            </div>

            <p style="text-align: center; color: #666;">扫描二维码在手机上查看</p>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h3 style="margin: 0 0 24px 0;">⚙️ 个人诊所设置</h3>
            <div id="success-msg" class="success-msg" style="display:none; color:green; margin-bottom:10px;"></div>
            <div class="form-group">
                <label>🔐 登录密码 (Login Password)</label>
                <input type="password" id="login-password" placeholder="主页密码">
            </div>
            <div class="form-group">
                <label>🏥 诊所名称 (Clinic Name)</label>
                <input type="text" id="inst-name-input" placeholder="例如：Putra Heights Care">
            </div>
            <div class="form-group">
                <label>📞 联系方式 (Contact)</label>
                <input type="tel" id="inst-contact-input" placeholder="例如：+603-1234-5678">
            </div>
            <div class="form-group">
                <label>🏥 Logo (Max 1)</label>
                <div class="upload-area" onclick="document.getElementById('logo-upload').click()">
                    <input type="file" id="logo-upload" accept="image/*" onchange="handleLogoUpload(this)">
                    <p id="upload-text" style="margin:0; color:#666;">点击上传 Logo</p>
                    <img id="logo-preview" style="display:none; max-height: 60px; margin: 10px auto; border-radius: 8px;">
                </div>
            </div>
            <button class="save-btn" style="background:#00b894; color:white; border:none; padding:10px 20px; border-radius:8px; width:100%;" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

<script>
    // --- FIREBASE INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
      authDomain: "pallicalc-eabdc.firebaseapp.com",
      projectId: "pallicalc-eabdc",
      storageBucket: "pallicalc-eabdc.firebasestorage.app",
      messagingSenderId: "347532270864",
      appId: "1:347532270864:web:bfe5bd1b92ccec22dc5995"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let context = {
        mode: 'personal', // personal | institution | shared
        instId: null
    };

    // --- 1. INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');

        if (ref) {
            context.mode = 'shared';
            context.instId = ref;
            hideSettingsButton();
        } else {
            // Check Auth
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const snap = await db.collection('users').doc(user.uid).get();
                    if (snap.exists && (snap.data().role === 'institutionUser' || snap.data().role === 'institutionAdmin')) {
                        context.mode = 'institution';
                        context.instId = snap.data().institutionId;
                        hideSettingsButton();
                    }
                }
                // If Personal Mode
                if (context.mode === 'personal') {
                    document.getElementById('settingsBtn').style.display = 'block';
                    loadLocalSettingsUI();
                }
            });
        }
    });

    function hideSettingsButton() {
        document.getElementById('settingsBtn').style.display = 'none';
    }

    // --- 2. DATA FETCHING ---
    async function getFooterData() {
        // A. FIREBASE
        if (context.mode !== 'personal' && context.instId) {
            try {
                const doc = await db.collection('institutions').doc(context.instId).get();
                if (doc.exists) {
                    const data = doc.data();
                    return {
                        name: data.headerName || data.name || "",
                        contact: data.headerContact || "",
                        logos: data.headerLogos || [] // Expecting Array of Base64
                    };
                }
            } catch (e) {
                console.error("Firebase fetch error", e);
            }
        }

        // B. LOCAL STORAGE (Legacy + New)
        const settingsStr = localStorage.getItem('institutionSettings');
        const s = settingsStr ? JSON.parse(settingsStr) : {};
        const logoArray = s.logo ? [s.logo] : [];
        return {
            name: s.name || "",
            contact: s.contact || "",
            logos: logoArray
        };
    }

    // --- 3. PDF GENERATION ---
    async function printPDF() {
        const loading = document.getElementById('pdf-loading');
        loading.style.display = 'flex';

        try {
            const footerData = await getFooterData();
            
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const pdfUrl = 'opioids-chinese.pdf'; 
            
            const response = await fetch(pdfUrl);
            if (!response.ok) throw new Error("PDF Template not found");
            const existingPdfBytes = await response.arrayBuffer();

            const pdfDoc = await PDFDocument.load(existingPdfBytes);
            const newPdf = await PDFDocument.create();
            
            const helveticaFont = await newPdf.embedFont(StandardFonts.Helvetica);
            const helveticaBold = await newPdf.embedFont(StandardFonts.HelveticaBold);

            // Process Logos
            let embeddedLogos = [];
            if (footerData.logos && footerData.logos.length > 0) {
                for (const logoSrc of footerData.logos) {
                    try {
                        let img;
                        if (logoSrc.startsWith('data:image/png')) img = await newPdf.embedPng(logoSrc);
                        else if (logoSrc.startsWith('data:image/jpeg') || logoSrc.startsWith('data:image/jpg')) img = await newPdf.embedJpg(logoSrc);
                        
                        if (img) {
                            const scale = 40 / img.height; 
                            embeddedLogos.push({ img, width: img.width * scale, height: img.height * scale });
                        }
                    } catch (e) { console.warn("Logo embed failed", e); }
                }
            }

            const embeddedPages = await newPdf.embedPdf(pdfDoc);
            const A4_W = 595.28;
            const A4_H = 841.89;
            const FOOTER_H = 50;

            for (const page of embeddedPages) {
                const newPage = newPdf.addPage([A4_W, A4_H]);
                
                const scale = Math.min(A4_W / page.width, (A4_H - FOOTER_H) / page.height);
                const w = page.width * scale;
                const h = page.height * scale;
                newPage.drawPage(page, {
                    x: (A4_W - w) / 2,
                    y: FOOTER_H,
                    width: w,
                    height: h
                });

                // Footer Line
                newPage.drawLine({
                    start: { x: 20, y: FOOTER_H },
                    end: { x: A4_W - 20, y: FOOTER_H },
                    thickness: 1,
                    color: rgb(0.8, 0.8, 0.8)
                });

                const centerY = FOOTER_H / 2;
                let currentX = 25;

                // Draw Logos
                for (const logo of embeddedLogos) {
                    newPage.drawImage(logo.img, {
                        x: currentX,
                        y: centerY - (logo.height / 2),
                        width: logo.width,
                        height: logo.height
                    });
                    currentX += logo.width + 10; 
                }

                // Draw Text
                const name = footerData.name || "PalliCalc Patient Education";
                const contact = footerData.contact ? `Contact: ${footerData.contact}` : "";

                const nameSize = 10;
                const contactSize = 8;
                let textY = contact ? centerY + 5 : centerY - 3;

                const nameW = helveticaBold.widthOfTextAtSize(name, nameSize);
                newPage.drawText(name, {
                    x: A4_W - 25 - nameW,
                    y: textY,
                    size: nameSize,
                    font: helveticaBold,
                    color: rgb(0.2, 0.2, 0.2)
                });

                if (contact) {
                    const contactW = helveticaFont.widthOfTextAtSize(contact, contactSize);
                    newPage.drawText(contact, {
                        x: A4_W - 25 - contactW,
                        y: textY - 12,
                        size: contactSize,
                        font: helveticaFont,
                        color: rgb(0.4, 0.4, 0.4)
                    });
                }
            }

            const pdfBytes = await newPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            window.open(URL.createObjectURL(blob), '_blank');

        } catch (e) {
            alert("PDF Generation Error: " + e.message);
            console.error(e);
        } finally {
            loading.style.display = 'none';
        }
    }

    // --- 4. LOCAL SETTINGS UI ---
    function loadLocalSettingsUI() {
        const s = localStorage.getItem('institutionSettings');
        if (s) {
            const settings = JSON.parse(s);
            if (settings.name) document.getElementById('inst-name-input').value = settings.name;
            if (settings.contact) document.getElementById('inst-contact-input').value = settings.contact;
            if (settings.logo) {
                document.getElementById('logo-preview').src = settings.logo;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('upload-text').style.display = 'none';
            }
        }
    }

    function handleLogoUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('logo-preview').src = e.target.result;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('upload-text').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveSettings() {
        const pwd = document.getElementById('login-password').value;
        const stored = localStorage.getItem('palliCalcLoginPassword');
        
        if (stored && pwd !== stored) {
            alert("密码错误");
            return;
        }

        const settings = {
            name: document.getElementById('inst-name-input').value,
            contact: document.getElementById('inst-contact-input').value,
            logo: document.getElementById('logo-preview').src
        };
        localStorage.setItem('institutionSettings', JSON.stringify(settings));
        
        const msg = document.getElementById('success-msg');
        msg.textContent = "设置已保存";
        msg.style.display = 'block';
        setTimeout(() => {
            msg.style.display = 'none';
            closeSettings();
        }, 1000);
    }

    // --- 5. UI HELPERS ---
    function goBack() { window.history.back(); }
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    
    function showQR() {
        const m = document.getElementById('qr-modal');
        const c = document.getElementById('qrcode');
        c.innerHTML = '';
        m.style.display = 'flex';

        const baseUrl = window.location.origin + window.location.pathname;
        const qrUrl = context.instId
            ? `${baseUrl}?ref=${context.instId}`
            : window.location.href;

        // Dark Mode Safe Colors
        new QRCode(c, { text: qrUrl, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff" });
    }
    
    function closeQR() { document.getElementById('qr-modal').style.display = 'none'; }
    window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display='none'; };
</script>
</body>
</html>