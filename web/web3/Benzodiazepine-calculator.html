<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Benzodiazepine Equivalence Calculator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <style>
    /* Layout basics */
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: 20px auto;
      font-size: 14px;
    }

    #nav { margin-bottom: 16px; }
    a { color: #007bff; text-decoration: underline; cursor: pointer; }
    h2 { margin-top: 0; margin-bottom: 20px; }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: normal;
    }

    input, select {
      display: block;
      margin-bottom: 18px;
      font-size: 14px;
      padding: 6px 8px;
      width: 100%;
      box-sizing: border-box;
    }

    .dose-input { display: inline-block; width: 70%; }
    .unit-span { display: inline-block; margin-left: 8px; vertical-align: middle; }

    .btn {
      border: none;
      cursor: pointer;
      width: 100%;
      margin-bottom: 20px;
      border-radius: 8px;
      padding: 14px;
    }

    .btn-primary { font-size: 18px; background-color: #007bff; color: white; }
    .btn-success { font-size: 12px; background-color: #28a745; color: white; max-width: 200px; }
    .btn-danger { background-color: #dc3545; color: white; font-size: 13px; }

    .result-box {
      margin-top: 20px;
      color: black;
      border: 2px solid #007bff;
      padding: 15px;
      background-color: white;
      font-size: 14px;
    }

    /* Comparison Table in Results */
    .comparison-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    .comparison-table th, .comparison-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .comparison-table th { background-color: #f2f2f2; font-weight: bold; }

    fieldset { border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 20px; }
    legend { font-weight: bold; font-size: 16px; padding: 0 5px; }
    .fieldset-convert { border: 2px solid #007bff; background-color: #f8faff; }
    .legend-blue { color: #007bff; }

    /* Nav Bar */
    .navbar-main {
      background: linear-gradient(135deg, #007bff, #0056b3);
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
    }

    .navbar-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
      padding: 8px 12px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 13px;
      display: inline-block;
    }

    /* MOBILE OPTIMIZED EDIT TABLE & FREEZE HEADER */
    .table-container {
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    #editPage table {
      width: 100%;
      border-collapse: separate; /* Required for sticky */
      border-spacing: 0;
      font-size: 11px; /* Smaller font for mobile */
    }

    #editPage thead th {
      position: sticky;
      top: 0;
      background-color: #f2f2f2;
      z-index: 10;
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
      border-bottom: 2px solid #ccc;
      padding: 6px 4px;
    }

    #editPage td {
      border-bottom: 1px solid #eee;
      padding: 4px 2px;
      background-color: white;
    }

    #editPage input, #editPage select {
      margin-bottom: 0;
      padding: 4px;
      height: 30px;
      font-size: 11px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Specific column sizing for mobile balance */
    .select-col { width: 30px; text-align: center; }
    .route-col { min-width: 60px; }
    .name-col { min-width: 90px; }
    .equiv-col { min-width: 50px; }
    .data-col { min-width: 65px; }

    #editPage .success { color: green; font-size: 13px; }
    #editPage .fail { color: red; font-size: 13px; }

    .ratio-banner {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      padding: 10px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 13px;
      display: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>

  <script>
    let auth, db;
    const firebaseConfig = {
      apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
      authDomain: "pallicalc-eabdc.firebaseapp.com",
      projectId: "pallicalc-eabdc",
      storageBucket: "pallicalc-eabdc.firebasestorage.app",
      messagingSenderId: "347532270864",
      appId: "1:347532270864:web:bfe5bd1b92ccec22dc5995",
      measurementId: "G-6G9C984F8E"
    };

    // 1. Initialize logic immediately to avoid delay
    function init() {
      // Load defaults or local storage immediately
      loadSavedData();
      fillAllSelects();
      
      // Show page immediately
      document.getElementById("calcPage").style.display = "block";
      
      // Start Firebase in background
      initFirebaseAuth();
    }

    async function initFirebaseAuth() {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      auth.onAuthStateChanged(async (user) => {
        if (!user) { return; } // Stay on personal default
        if (!user.emailVerified) { return; }
        
        const snap = await db.collection("users").doc(user.uid).get();
        if (!snap.exists) { return; }
        
        const profile = snap.data();
        if (profile.role === "institutionAdmin") { window.location.href = "Admin.html"; return; }
        
        window.PALLICALC_USER = { role: profile.role, institutionId: profile.institutionId || null };
        
        // Re-apply rules based on verified user role
        applyMemberRules();
      });
    }

    async function applyMemberRules() {
      const role = window.PALLICALC_USER.role;
      if (role === "institutionUser") {
        // Clear personal overrides if institution user
        localStorage.removeItem("benzoTypes");
        localStorage.removeItem("benzoIncluded");
        await loadRatiosFromFirebase();
      } else {
         // Personal user: data already loaded by init(), just ensure banner is right
         loadSavedData(); 
      }
      
      if (role === "institutionUser") {
        const originalNavigateToEdit = window.navigateToEdit;
        window.navigateToEdit = function () {
          originalNavigateToEdit();
          setTimeout(lockEditPageForInstitutionUser, 0);
        };
      }
    }

    function updateBanner(userType, isCustom, timestamp = null, instName = null) {
      const banner = document.getElementById("ratioBanner");
      let html = "";
      let dateStr = "";
      if (timestamp) {
        const dateObj = (timestamp && typeof timestamp.toDate === 'function') ? timestamp.toDate() : new Date(timestamp);
        if (!isNaN(dateObj)) dateStr = ` (Saved: ${dateObj.toLocaleDateString()} ${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})`;
      }
      if (userType === "personal") {
        html = isCustom ? `<strong>Personal User:</strong> <span style="color:#198754; font-weight:bold;">Custom Ratios</span>${dateStr}` : `<strong>Personal User:</strong> <span style="color:#6c757d; font-style:italic;">Default Ratios</span>`;
      } else if (userType === "institution") {
        html = isCustom ? `<strong>${instName || "Institution"}:</strong> <span style="color:#198754; font-weight:bold;">Custom Ratios</span>${dateStr}` : `<strong>${instName || "Institution"}:</strong> <span style="color:#6c757d; font-style:italic;">Default Ratios</span>`;
      }
      banner.innerHTML = html;
      banner.style.display = "block";
    }

    async function loadRatiosFromFirebase() {
        try {
          const instId = window.PALLICALC_USER.institutionId;
          if (!instId) { loadHardcodedDefaults(); updateBanner("institution", false); return; }
          const ref = await db.collection("benzoRatios").doc(instId).get();
          if (ref.exists) {
            const data = ref.data();
            benzoTypes = data.benzoTypes || [];
            includedKeys = data.includedKeys ? new Set(data.includedKeys) : new Set(benzoTypes.map(b => b.key));
            fillAllSelects();
            updateBanner("institution", true, data.updatedAt);
          } else {
            loadHardcodedDefaults();
            updateBanner("institution", false);
          }
        } catch (e) { loadHardcodedDefaults(); updateBanner("institution", false); }
    }

    function loadHardcodedDefaults() {
      benzoTypes = JSON.parse(JSON.stringify(defaultBenzoTypes));
      includedKeys = new Set(benzoTypes.map(b => b.key));
      fillAllSelects();
    }

    function lockEditPageForInstitutionUser() {
      document.getElementById("saveBtn")?.remove();
      document.getElementById("passInput")?.remove();
      document.getElementById("resetBtn")?.remove();
      document.querySelector("label[for='passInput']")?.remove();
      const info = document.createElement("div");
      info.style = "background:#ffdddd; border:1px solid #ff5c5c; color:#a70000; font-weight:bold; margin-bottom:12px; padding:10px; border-radius:4px; font-size:12px;";
      info.innerHTML = "Institutional users cannot modify conversion data.";
      document.getElementById("editPage").prepend(info);
    }
    
    document.addEventListener("DOMContentLoaded", init);
  </script>

  <nav class="navbar-main">
    <a href="all-calculators.html" class="navbar-link"><i class="bi bi-house-door"></i> Back to All Calculators</a>
    <a href="Benzodiazepines-conversion-guide.html" class="navbar-link">📖 Guide</a>
  </nav>

  <div id="nav">
    <span id="toCalcLink" style="display:none;"><a onclick="navigateToCalc()">← Back</a></span>
    <span id="toEditLink"><a onclick="navigateToEdit()">Edit Equivalence Data</a></span>
  </div>

  <div id="ratioBanner" class="ratio-banner"></div>

  <div id="calcPage" style="display:none;">
    <h2>Benzo Equivalence</h2>
    <fieldset>
      <legend>Current Drug</legend>
      <select id="inputRoute1"></select>
      <select id="inputName1"></select>
      <label>Dose (mg)</label>
      <input type="number" id="inputDose1" class="dose-input" /> <span class="unit-span">mg</span>
    </fieldset>

    <button id="showExtraBtn" class="btn btn-success" onclick="toggleExtra()">Add More</button>

    <fieldset id="extraBenzo1" style="display:none;">
      <legend>Additional 1</legend>
      <select id="inputRoute2"></select>
      <select id="inputName2"></select>
      <input type="number" id="inputDose2" class="dose-input" /> mg
    </fieldset>

    <fieldset id="extraBenzo2" style="display:none;">
      <legend>Additional 2</legend>
      <select id="inputRoute3"></select>
      <select id="inputName3"></select>
      <input type="number" id="inputDose3" class="dose-input" /> mg
    </fieldset>

    <fieldset id="extraBenzo3" style="display:none;">
      <legend>Additional 3</legend>
      <select id="inputRoute4"></select>
      <select id="inputName4"></select>
      <input type="number" id="inputDose4" class="dose-input" /> mg
    </fieldset>

    <fieldset class="fieldset-convert">
      <legend class="legend-blue">Convert To</legend>
      <select id="outputRoute"></select>
      <select id="outputName"></select>
    </fieldset>

    <button class="btn btn-primary" onclick="convert()">Calculate</button>
    <div id="resultBox" class="result-box" style="display:none;"></div>
    <button class="btn btn-danger" onclick="clearCalculator()">Clear</button>
  </div>

  <div id="editPage" style="display:none;">
    <h2>Edit Benzo Data</h2>
    <form onsubmit="return saveRatios();">
      <button id="resetBtn" class="btn btn-danger" type="button" onclick="resetToDefaults()">Reset Defaults</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="select-col">Use</th>
              <th class="route-col">Route</th>
              <th class="name-col">Drug</th>
              <th class="equiv-col">Equiv</th>
              <th class="data-col">Onset</th>
              <th class="data-col">Dur.</th>
            </tr>
          </thead>
          <tbody id="ratioTableBody"></tbody>
        </table>
      </div>

      <label for="passInput">Enter login password:</label>
      <input type="password" id="passInput" autocomplete="off" />
      <button id="saveBtn" class="btn btn-primary" type="submit">Save Changes</button>
      <span id="msgArea" class="success" style="display:none;"></span>
      <span id="errorArea" class="fail" style="display:none;"></span>
    </form>
  </div>

  <script>
    const ROUTES = ["PO", "IV", "SL/Buccal", "IM", "SC"];
    const defaultBenzoTypes = [
      { key: "alprazolam", label: "Alprazolam", route: "PO", equiv: 1, onset: "30 min", duration: "6-20 h" },
      { key: "lorazepam", label: "Lorazepam", route: "PO", equiv: 2, onset: "30-60 min", duration: "10-20 h" },
      { key: "bromazepam", label: "Bromazepam", route: "PO", equiv: 6, onset: "30m-4h", duration: "10-20 h" },
      { key: "midazolam_iv", label: "Midazolam", route: "IV", equiv: 4, onset: "1-3 min", duration: "2-4 h" },
      { key: "chlordiazepoxide", label: "Chlordiazepoxide", route: "PO", equiv: 50, onset: "1.5 h", duration: "5-30 h" },
      { key: "clonazepam", label: "Clonazepam", route: "PO", equiv: 1, onset: "1 h", duration: "18-39 h" },
      { key: "diazepam", label: "Diazepam", route: "PO", equiv: 15, onset: "30 min", duration: "20-50 h" }
    ];

    let benzoTypes = [];
    let includedKeys = new Set();

    function loadSavedData() {
      let savedTypes = localStorage.getItem("benzoTypes");
      let savedIncluded = localStorage.getItem("benzoIncluded");
      let savedTime = localStorage.getItem("benzoSavedTime");
      if (savedTypes) {
        benzoTypes = JSON.parse(savedTypes);
        if (savedIncluded) { try { const incl = JSON.parse(savedIncluded); includedKeys = new Set(incl); } catch {} }
        updateBanner("personal", true, savedTime);
      } else {
        benzoTypes = JSON.parse(JSON.stringify(defaultBenzoTypes));
        includedKeys = new Set(benzoTypes.map(b => b.key));
        updateBanner("personal", false);
      }
    }

    function navigateToEdit() {
      document.getElementById("calcPage").style.display = "none";
      document.getElementById("editPage").style.display = "block";
      document.getElementById("toEditLink").style.display = "none";
      document.getElementById("toCalcLink").style.display = "";
      document.getElementById("msgArea").style.display = "none"; // Hide msg
      generateEditTable();
    }

    function navigateToCalc() {
      document.getElementById("editPage").style.display = "none";
      document.getElementById("calcPage").style.display = "block";
      document.getElementById("toEditLink").style.display = "";
      document.getElementById("toCalcLink").style.display = "none";
      fillAllSelects();
    }

    function fillAllSelects() {
      const inputRoutes = ["inputRoute1", "inputRoute2", "inputRoute3", "inputRoute4"];
      const inputNames = ["inputName1", "inputName2", "inputName3", "inputName4"];
      
      // Collect valid routes
      const availableRoutes = [...new Set(benzoTypes.filter(b => includedKeys.has(b.key)).map(b => b.route))].sort();

      inputRoutes.forEach((rid, idx) => {
        const sel = document.getElementById(rid);
        // Preserve selection if possible
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">Route</option>';
        availableRoutes.forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
        if(currentVal && availableRoutes.includes(currentVal)) sel.value = currentVal;

        sel.onchange = () => {
          const nSel = document.getElementById(inputNames[idx]);
          nSel.innerHTML = '<option value="">Drug</option>';
          benzoTypes.filter(b => b.route === sel.value && includedKeys.has(b.key)).forEach(b => nSel.innerHTML += `<option value="${b.key}">${b.label}</option>`);
        };
        // Trigger fill for names if route is selected
        if(sel.value) {
            const nSel = document.getElementById(inputNames[idx]);
            const currName = nSel.value;
            nSel.innerHTML = '<option value="">Drug</option>';
            benzoTypes.filter(b => b.route === sel.value && includedKeys.has(b.key)).forEach(b => nSel.innerHTML += `<option value="${b.key}">${b.label}</option>`);
            if(currName) nSel.value = currName;
        }
      });

      const oRoute = document.getElementById("outputRoute");
      const currentOR = oRoute.value;
      oRoute.innerHTML = '<option value="">Route</option>';
      availableRoutes.forEach(r => oRoute.innerHTML += `<option value="${r}">${r}</option>`);
      if(currentOR && availableRoutes.includes(currentOR)) oRoute.value = currentOR;

      oRoute.onchange = () => {
        const onSel = document.getElementById("outputName");
        onSel.innerHTML = '<option value="">Drug</option>';
        benzoTypes.filter(b => b.route === oRoute.value && includedKeys.has(b.key)).forEach(b => onSel.innerHTML += `<option value="${b.key}">${b.label}</option>`);
      };
      // Trigger output name fill
      if(oRoute.value) {
        const onSel = document.getElementById("outputName");
        const currName = onSel.value;
        onSel.innerHTML = '<option value="">Drug</option>';
        benzoTypes.filter(b => b.route === oRoute.value && includedKeys.has(b.key)).forEach(b => onSel.innerHTML += `<option value="${b.key}">${b.label}</option>`);
        if(currName) onSel.value = currName;
      }
    }

    let extraCount = 0;
    function toggleExtra() {
        extraCount = (extraCount + 1) % 4;
        document.getElementById("extraBenzo1").style.display = extraCount >= 1 ? 'block' : 'none';
        document.getElementById("extraBenzo2").style.display = extraCount >= 2 ? 'block' : 'none';
        document.getElementById("extraBenzo3").style.display = extraCount >= 3 ? 'block' : 'none';
        document.getElementById("showExtraBtn").textContent = extraCount === 3 ? "Hide Extra" : "Add More";
    }

    function convert() {
        const targetKey = document.getElementById("outputName").value;
        if(!targetKey) { alert("Select target."); return; }
        let totalUnits = 0;
        let used = [];
        for(let i=1; i<=4; i++){
            const d = parseFloat(document.getElementById(`inputDose${i === 1 ? '1' : i}`).value);
            const k = document.getElementById(`inputName${i === 1 ? '1' : i}`).value;
            if(d > 0 && k) {
                const drug = benzoTypes.find(b => b.key === k);
                totalUnits += (d / drug.equiv);
                used.push({n: drug.label, d: d, o: drug.onset, du: drug.duration});
            }
        }
        const target = benzoTypes.find(b => b.key === targetKey);
        const res = (totalUnits * target.equiv).toFixed(2);
        document.getElementById("resultBox").innerHTML = `<b>Total (${target.label}): ${res} mg</b>`;
        document.getElementById("resultBox").style.display = 'block';
    }

    function clearCalculator() {
        document.querySelectorAll('input[type="number"]').forEach(i => i.value="");
        document.getElementById("resultBox").style.display='none';
    }

    function generateEditTable() {
        const tbody = document.getElementById("ratioTableBody");
        tbody.innerHTML = "";
        
        // 1. Existing Ratios
        benzoTypes.forEach(b => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="select-col"><input type="checkbox" data-key="${b.key}" ${includedKeys.has(b.key)?'checked':''} class="item-check"></td>
                <td class="route-col"><select id="editRoute_${b.key}">${ROUTES.map(r=>`<option ${r===b.route?'selected':''}>${r}</option>`)}</select></td>
                <td class="name-col"><input type="text" id="editName_${b.key}" value="${b.label}"></td>
                <td class="equiv-col"><input type="number" step="0.01" id="editEquiv_${b.key}" value="${b.equiv}"></td>
                <td class="data-col"><input type="text" id="editOnset_${b.key}" value="${b.onset}"></td>
                <td class="data-col"><input type="text" id="editDur_${b.key}" value="${b.duration}"></td>
            `;
            tbody.appendChild(tr);
        });

        // 2. Add 6 Empty Rows for New Benzos (Matching Opioid Calc Style)
        for (let i = 1; i <= 6; i++) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="select-col"><input type="checkbox" data-new="true" data-idx="${i}" class="new-check"></td>
            <td class="route-col">
              <select id="newRoute_${i}">
                <option value="">Route</option>
                ${ROUTES.map(r => `<option value="${r}">${r}</option>`).join('')}
              </select>
            </td>
            <td class="name-col"><input type="text" id="newName_${i}" placeholder="New Drug ${i}"></td>
            <td class="equiv-col"><input type="number" step="0.01" id="newEquiv_${i}" placeholder="Equiv"></td>
            <td class="data-col"><input type="text" id="newOnset_${i}" placeholder="Onset"></td>
            <td class="data-col"><input type="text" id="newDur_${i}" placeholder="Duration"></td>
          `;
          tbody.appendChild(tr);
        }
    }

    function saveRatios() {
        const pwd = document.getElementById("passInput").value;
        const msg = document.getElementById("msgArea");
        
        if(pwd !== localStorage.getItem("palliCalcLoginPassword")) { alert("Wrong password"); return false; }
        
        let newTypes = [];
        let newIncluded = [];

        // 1. Process existing rows
        benzoTypes.forEach(b => {
           const cb = document.querySelector(`input[data-key="${b.key}"]`);
           if(cb) {
             // If existing checkbox is checked, add to included
             if(cb.checked) newIncluded.push(b.key);
             
             // Update values from table
             newTypes.push({
                key: b.key,
                label: document.getElementById(`editName_${b.key}`).value,
                route: document.getElementById(`editRoute_${b.key}`).value,
                equiv: parseFloat(document.getElementById(`editEquiv_${b.key}`).value),
                onset: document.getElementById(`editOnset_${b.key}`).value,
                duration: document.getElementById(`editDur_${b.key}`).value
             });
           }
        });

        // 2. Process NEW rows
        for (let i = 1; i <= 6; i++) {
           const cb = document.querySelector(`input[data-new="true"][data-idx="${i}"]`);
           const route = document.getElementById(`newRoute_${i}`).value;
           const name = document.getElementById(`newName_${i}`).value;
           const equiv = document.getElementById(`newEquiv_${i}`).value;
           
           // Only add if checked AND has basic data
           if(cb && cb.checked && route && name && equiv) {
              const safeKey = "custom_" + name.toLowerCase().replace(/[^a-z0-9]/g, "_") + "_" + Math.floor(Math.random()*1000);
              newTypes.push({
                 key: safeKey,
                 label: name,
                 route: route,
                 equiv: parseFloat(equiv),
                 onset: document.getElementById(`newOnset_${i}`).value || "",
                 duration: document.getElementById(`newDur_${i}`).value || ""
              });
              newIncluded.push(safeKey);
           }
        }

        benzoTypes = newTypes;
        includedKeys = new Set(newIncluded);

        localStorage.setItem("benzoTypes", JSON.stringify(benzoTypes));
        localStorage.setItem("benzoIncluded", JSON.stringify(newIncluded));
        localStorage.setItem("benzoSavedTime", new Date().toISOString());
        
        msg.style.display = "inline";
        msg.innerText = "Saved successfully!";
        document.getElementById("passInput").value = "";
        
        setTimeout(() => {
           navigateToCalc();
        }, 1000);
        
        return false;
    }

    function resetToDefaults() {
        if(confirm("Reset to system defaults?")) { localStorage.removeItem("benzoTypes"); loadSavedData(); generateEditTable(); }
    }
  </script>
</body>
</html>